#!/usr/bin/env bash

# Exit on any error and ensure pipeline failures are caught
set -e
set -o pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "ðŸ” Running pre-commit checks..."

# Add Homebrew to PATH if it exists
if [ -d "/opt/homebrew/bin" ]; then
    export PATH="/opt/homebrew/bin:$PATH"
elif [ -d "/usr/local/bin" ]; then
    export PATH="/usr/local/bin:$PATH"
fi

# Get staged Swift files (excluding deleted files and build directories)
STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=d | grep '\.swift$' || true)
STAGED_SWIFT_FILES=$(echo "$STAGED_SWIFT_FILES" | grep -v -E '^\.derivedData/|^\.build/|/\.build/' || true)

if [ -z "$STAGED_SWIFT_FILES" ]; then
    echo -e "${GREEN}âœ“ No Swift files staged, skipping checks${NC}"
    exit 0
fi

echo "ðŸ“ Checking $(echo "$STAGED_SWIFT_FILES" | wc -l | tr -d ' ') Swift file(s)"

# Check if SwiftFormat is available
if command -v swiftformat &> /dev/null; then
    echo "ðŸŽ¨ Running SwiftFormat..."
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            swiftformat "$file"
            git add "$file"
        fi
    done <<< "$STAGED_SWIFT_FILES"
else
    echo -e "${YELLOW}âš  SwiftFormat not found, skipping formatting${NC}"
fi

# Check if SwiftLint is available
if command -v swiftlint &> /dev/null; then
    echo "ðŸ”Ž Running SwiftLint..."

    LINT_ERRORS=0
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            # Run SwiftLint with auto-fix
            swiftlint lint --fix "$file" 2>/dev/null || true

            # Re-add after auto-fix
            git add "$file"

            # Check for remaining errors
            if ! swiftlint lint --quiet "$file" 2>/dev/null; then
                LINT_ERRORS=$((LINT_ERRORS + 1))
                echo -e "${RED}âœ— Lint errors in: $file${NC}"
            fi
        fi
    done <<< "$STAGED_SWIFT_FILES"

    if [ $LINT_ERRORS -gt 0 ]; then
        echo -e "${RED}âœ— SwiftLint found errors that couldn't be auto-fixed${NC}"
        echo "Run 'swiftlint' to see details"
        exit 1
    fi

    echo -e "${GREEN}âœ“ SwiftLint passed${NC}"
else
    echo -e "${YELLOW}âš  SwiftLint not found, skipping lint check${NC}"
fi

echo -e "${GREEN}âœ“ Pre-commit checks passed${NC}"
exit 0
