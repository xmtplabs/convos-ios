#!/usr/bin/env bash

# Exit on any error and ensure pipeline failures are caught
# set -o errexit -o pipefail -o nounset

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored messages
info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Add Homebrew to PATH if it exists
if [ -d "/opt/homebrew/bin" ]; then
    export PATH="/opt/homebrew/bin:$PATH"
elif [ -d "/usr/local/bin" ]; then
    export PATH="/usr/local/bin:$PATH"
fi

# Check for SwiftLint (pinned to 0.62.2 for compatibility with project)
SWIFTLINT_VERSION="0.62.2"
install_swiftlint() {
    echo "Installing SwiftLint ${SWIFTLINT_VERSION}..."
    local tmp_dir=$(mktemp -d)
    curl -sL "https://github.com/realm/SwiftLint/releases/download/${SWIFTLINT_VERSION}/portable_swiftlint.zip" -o "${tmp_dir}/swiftlint.zip"
    unzip -o "${tmp_dir}/swiftlint.zip" -d "${tmp_dir}"
    sudo mv "${tmp_dir}/swiftlint" /usr/local/bin/swiftlint
    rm -rf "${tmp_dir}"
}

if ! command -v swiftlint &> /dev/null; then
    warn "SwiftLint is not installed"
    install_swiftlint
elif [[ "$(swiftlint version)" != "${SWIFTLINT_VERSION}" ]]; then
    warn "SwiftLint version mismatch. Found $(swiftlint version), expected ${SWIFTLINT_VERSION}."
    echo "Updating SwiftLint..."
    install_swiftlint
fi

# Check for SwiftFormat
if ! command -v swiftformat &> /dev/null; then
    warn "SwiftFormat is not installed"
    echo "Installing SwiftFormat..."
    if ! brew install swiftformat; then
        error "Failed to install SwiftFormat"
        echo "Please install SwiftFormat manually using:"
        echo "  brew install swiftformat"
        exit 1
    fi
fi

# Verify tools are available
if ! command -v swiftlint &> /dev/null || ! command -v swiftformat &> /dev/null; then
    error "SwiftLint or SwiftFormat is not available in PATH"
    echo "Please try running:"
    echo "  export PATH=\"/opt/homebrew/bin:$PATH\""
    echo "And then try your commit again"
    exit 1
fi

info "SwiftLint and SwiftFormat are installed"

# Get list of staged Swift files
info "Checking for staged Swift files..."

git diff --diff-filter=d --staged --name-only | grep -e '\(.*\).swift$' | while read line; do
  echo "-asdf-a-sdf-asdf-"
  swiftformat "${line}";
  git add "$line";
done

info "All Swift files passed linting and formatting checks"
exit 0
