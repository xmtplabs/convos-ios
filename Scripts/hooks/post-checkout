#!/usr/bin/env bash

# post-checkout
#
# https://git-scm.com/docs/githooks#_post_checkout
# Also runs after `git worktree add` (with $1 = null-ref, $3 = 1)

git_root="$(git rev-parse --show-toplevel)"

# if this is a file checkout then do nothing
if [ "${3}" == "0" ]; then exit; fi

# if same commit before and after checkout then do nothing
if [ "${1}" == "${2}" ]; then exit; fi

# Copy .env from main repo to worktree if it doesn't exist yet
main_repo="$(git rev-parse --git-common-dir | sed 's|/\.git$||')"
if [ "$main_repo" != "$git_root" ] && [ -f "$main_repo/.env" ] && [ ! -f "$git_root/.env" ]; then
    cp "$main_repo/.env" "$git_root/.env"
    echo "ðŸ“‹ Copied .env from main repo to worktree"
fi

# Git
cd "${git_root}" && git submodule update --init --recursive

# Ensure minimal Secrets.swift exists first (important for first-time setup)
./Scripts/generate-secrets-local.sh --ensure-only

# Generate full secrets (smart detection: local vs CI)
make secrets
