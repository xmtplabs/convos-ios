#!/bin/bash
#
# Deploy XMTP test infrastructure to Fly.io
#
# Usage:
#   ./ci/fly/deploy [APP_NAME]
#
# If APP_NAME is not provided, generates one using timestamp.
#
# Outputs (to stdout):
#   app_name=<name>
#   node_url=<url>
#   history_url=<url>
#
# Environment:
#   FLY_API_TOKEN - Required for Fly.io authentication
#   FLY_ORG       - Organization to deploy to (default: xmtp-labs)
#   FLY_REGION    - Region to deploy to (default: iad)

set -e

# Validate required environment variables
if [ -z "$FLY_API_TOKEN" ]; then
    echo "Error: FLY_API_TOKEN is not set" >&2
    exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Note: machine-config.json contains hardcoded credentials (postgres passwords, node keys)
# These are intentionally non-secret as they're only used for ephemeral CI test environments
MACHINE_CONFIG="${SCRIPT_DIR}/machine-config.json"

FLY_ORG="${FLY_ORG:-xmtp-labs}"
FLY_REGION="${FLY_REGION:-iad}"

# Generate or use provided app name
if [ -n "$1" ]; then
    APP_NAME="$1"
else
    APP_NAME="convos-ios-test-$(date +%s)"
fi

echo "Creating app: $APP_NAME" >&2

# Create the app (fail if creation fails for reasons other than "already exists")
flyctl apps create "$APP_NAME" --org "$FLY_ORG" 2>/dev/null || {
    flyctl apps show "$APP_NAME" >/dev/null 2>&1 || {
        echo "Failed to create app: $APP_NAME" >&2
        exit 1
    }
}

# Allocate IP addresses for the app (ignore if already allocated)
echo "Allocating IP addresses..." >&2
flyctl ips allocate-v4 --shared --app "$APP_NAME" 2>/dev/null || true
flyctl ips allocate-v6 --app "$APP_NAME" 2>/dev/null || true

# Deploy multi-container machine
echo "Deploying multi-container machine..." >&2
flyctl machine run \
    --app "$APP_NAME" \
    --region "$FLY_REGION" \
    --rm \
    --restart no \
    --machine-config "$MACHINE_CONFIG"

# Wait for TLS to be ready
APP_HOSTNAME="${APP_NAME}.fly.dev"
MAX_TLS_ATTEMPTS=60
TLS_ATTEMPT=0

echo "Waiting for TLS to be ready..." >&2
while [[ $TLS_ATTEMPT -lt $MAX_TLS_ATTEMPTS ]]; do
    if openssl s_client -connect "$APP_HOSTNAME:443" -servername "$APP_HOSTNAME" </dev/null 2>/dev/null | grep -q "CONNECTED"; then
        echo "TLS is ready!" >&2
        break
    fi

    TLS_ATTEMPT=$((TLS_ATTEMPT + 1))
    echo "  Attempt $TLS_ATTEMPT/$MAX_TLS_ATTEMPTS - waiting for TLS..." >&2
    sleep 5
done

if [[ $TLS_ATTEMPT -ge $MAX_TLS_ATTEMPTS ]]; then
    echo "Error: TLS failed to become ready within timeout" >&2
    exit 1
fi

# Give the gRPC service a moment to fully initialize after TLS is ready
echo "Waiting for gRPC service to initialize..." >&2
sleep 10

XMTP_URL="https://${APP_HOSTNAME}:443"

echo "" >&2
echo "Deployment complete!" >&2
echo "" >&2

# Output results for GitHub Actions
echo "app_name=$APP_NAME"
echo "xmtp_node_address=$XMTP_URL"
echo "xmtp_is_secure=true"

# Also write to GITHUB_OUTPUT if available
if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
    echo "app_name=$APP_NAME" >> "$GITHUB_OUTPUT"
    echo "xmtp_node_address=$XMTP_URL" >> "$GITHUB_OUTPUT"
    echo "xmtp_is_secure=true" >> "$GITHUB_OUTPUT"
fi
