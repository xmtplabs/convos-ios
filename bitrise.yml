---
format_version: '23'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: ios
app:
  envs:
  - ENABLE_APPCLIP: 'false'
    opts:
      is_expand: false
  - TEST_SHARD_COUNT: 2
  - BITRISE_PROJECT_PATH: Convos.xcodeproj
    opts:
      is_expand: false
  - BITRISE_DISTRIBUTION_METHOD: app-store
    opts:
      is_expand: false
  - POSTHOG_HOST: https://us.i.posthog.com
    opts:
      is_expand: false
  - SENTRY_ORG: ephemerahq
    opts:
      is_expand: false
  - SENTRY_PROJECT: convos-ios
    opts:
      is_expand: false
  - GITHUB_REPOSITORY: ephemeraHQ/convos-ios
    opts:
      is_expand: false
workflows:
  archive_and_export_dev:
    summary: Create a dev build and upload it to App Store Connect for TestFlight
      internal testing
    steps:
    - git-clone@8: {}
    - restore-spm-cache@2: {}
    - bundle::Setup: {}
    - bundle::ReleaseNotes: {}
    - set-xcode-build-number@2:
        title: Set Build Number - Main App
        inputs:
        - verbose: true
        - target: Convos
        - scheme: "$BITRISE_SCHEME"
    - set-xcode-build-number@2:
        title: Set Build Number - NSE
        inputs:
        - verbose: true
        - scheme: "$BITRISE_SCHEME_NSE"
        - target: NotificationService
    - set-xcode-build-number@2:
        title: Set Build Number - AppClip
        run_if: '{{enveq "ENABLE_APPCLIP" "true"}}'
        inputs:
        - verbose: true
        - target: ConvosAppClip
        - scheme: "$BITRISE_SCHEME_APPCLIP"
    - manage-ios-code-signing@2:
        inputs:
        - distribution_method: app-store
        - verbose_log: 'yes'
        - scheme: "$BITRISE_SCHEME"
        - configuration: "$BITRISE_BUILD_CONFIG"
        title: iOS Code Signing - Main App
    - manage-ios-code-signing@2:
        inputs:
        - distribution_method: app-store
        - scheme: "$BITRISE_SCHEME_NSE"
        - configuration: "$BITRISE_BUILD_CONFIG"
        title: iOS Code Signing - NSE
    - manage-ios-code-signing@2:
        title: iOS Code Signing - AppClip
        run_if: '{{enveq "ENABLE_APPCLIP" "true"}}'
        inputs:
        - distribution_method: app-store
        - scheme: "$BITRISE_SCHEME_APPCLIP"
        - configuration: "$BITRISE_BUILD_CONFIG"
        - verbose_log: 'yes'
    - xcode-archive@5:
        inputs:
        - project_path: "$BITRISE_PROJECT_PATH"
        - cache_level: none
        - verbose_log: 'yes'
        - distribution_method: app-store
        - platform: iOS
        - perform_clean_action: 'yes'
        - automatic_code_signing: api-key
        - scheme: "$BITRISE_SCHEME"
        - configuration: "$BITRISE_BUILD_CONFIG"
    - deploy-to-itunesconnect-application-loader@2:
        inputs:
        - bundle_id: org.convos.ios-preview
        - app_id: '6748622252'
    - save-spm-cache@1: {}
    meta:
      bitrise.io:
        stack: osx-xcode-26.0.x
    envs:
    - BITRISE_SCHEME: Convos (Dev)
      opts:
        is_expand: false
    - BITRISE_SCHEME_NSE: NotificationService (Dev)
      opts:
        is_expand: false
    - BITRISE_SCHEME_APPCLIP: ConvosAppClip (Dev)
      opts:
        is_expand: false
    - BITRISE_BUILD_CONFIG: Dev
      opts:
        is_expand: false
    triggers:
      tag:
      - name: "*"
  archive_and_export_prod:
    summary: Create a production build and upload it to App Store Connect
    steps:
    - git-clone@8: {}
    - restore-spm-cache@2: {}
    - bundle::Setup: {}
    - bundle::ReleaseNotes: {}
    - set-xcode-build-number@2:
        title: Set Build Number - Main App
        inputs:
        - verbose: true
        - target: Convos
        - scheme: "$BITRISE_SCHEME"
    - set-xcode-build-number@2:
        title: Set Build Number - NSE
        inputs:
        - verbose: true
        - scheme: "$BITRISE_SCHEME_NSE"
        - target: NotificationService
    - set-xcode-build-number@2:
        title: Set Build Number - AppClip
        run_if: '{{enveq "ENABLE_APPCLIP" "true"}}'
        inputs:
        - verbose: true
        - target: ConvosAppClip
        - scheme: "$BITRISE_SCHEME_APPCLIP"
    - manage-ios-code-signing@2:
        inputs:
        - distribution_method: app-store
        - verbose_log: 'yes'
        - scheme: "$BITRISE_SCHEME"
        - configuration: "$BITRISE_BUILD_CONFIG"
        title: iOS Code Signing - Main App
    - manage-ios-code-signing@2:
        inputs:
        - distribution_method: app-store
        - scheme: "$BITRISE_SCHEME_NSE"
        - configuration: "$BITRISE_BUILD_CONFIG"
        title: iOS Code Signing - NSE
    - manage-ios-code-signing@2:
        title: iOS Code Signing - AppClip
        run_if: '{{enveq "ENABLE_APPCLIP" "true"}}'
        inputs:
        - distribution_method: app-store
        - scheme: "$BITRISE_SCHEME_APPCLIP"
        - configuration: "$BITRISE_BUILD_CONFIG"
        - verbose_log: 'yes'
    - xcode-archive@5:
        inputs:
        - project_path: "$BITRISE_PROJECT_PATH"
        - cache_level: none
        - verbose_log: 'yes'
        - distribution_method: app-store
        - platform: iOS
        - perform_clean_action: 'yes'
        - automatic_code_signing: api-key
        - scheme: "$BITRISE_SCHEME"
        - configuration: "$BITRISE_BUILD_CONFIG"
    - deploy-to-itunesconnect-application-loader@2:
        inputs:
        - app_id: '6744776535'
        - bundle_id: org.convos.ios
    - save-spm-cache@1: {}
    meta:
      bitrise.io:
        stack: osx-xcode-26.0.x
    triggers:
      push:
      - branch: main
    envs:
    - BITRISE_SCHEME: Convos (Prod)
      opts:
        is_expand: false
    - BITRISE_SCHEME_NSE: NotificationService (Prod)
      opts:
        is_expand: false
    - BITRISE_SCHEME_APPCLIP: ConvosAppClip (Prod)
      opts:
        is_expand: false
    - BITRISE_BUILD_CONFIG: Release
      opts:
        is_expand: false
  build_for_testing:
    steps:
    - git-clone@8: {}
    - restore-spm-cache@2.1:
        inputs:
        - retries: '3'
    - bundle::Setup: {}
    - xcode-build-for-test@3:
        inputs:
        - project_path: "$BITRISE_PROJECT_PATH"
        - scheme: Convos (Dev)
        - destination: generic/platform=iOS Simulator
        - cache_level: none
        - configuration: Debug
    - save-spm-cache@1: {}
    - xcode-test-shard-calculation@0:
        inputs:
        - shard_count: "$TEST_SHARD_COUNT"
        - product_path: "$BITRISE_XCTESTRUN_FILE_PATH"
    meta:
      bitrise.io:
        stack: osx-xcode-26.0.x-edge
    triggers:
      pull_request:
      - source_branch: "*"
      enabled: false
meta:
  bitrise.io:
    stack: osx-xcode-26.0.x-edge
    machine_type_id: g2.mac.medium
step_bundles:
  Setup:
    steps:
    - script@1:
        title: Setup
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # make pipelines' return status equal the last command to exit with a non-zero status, or zero if all commands exit successfully
            set -o pipefail
            # debug log
            # set -x

            make setup
            make secrets
  ReleaseNotes:
    steps:
    - script@1:
        title: Read Release Notes from GitHub Release
        inputs:
        - content: "./Scripts/read-release-notes.sh"
        is_skippable: true
