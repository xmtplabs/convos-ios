#!/bin/bash
# Convos iOS task management with git worktrees + Graphite

set -e

# Detect repo location dynamically
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MAIN_REPO="$(cd "$SCRIPT_DIR/../.." && pwd)"
REPO_NAME="$(basename "$MAIN_REPO")"
BASE_DIR="$(dirname "$MAIN_REPO")"

# Base simulator to clone from (can be overridden with CONVOS_BASE_SIMULATOR env var)
# If not set, will auto-detect an available iPhone simulator
BASE_SIMULATOR="${CONVOS_BASE_SIMULATOR:-}"

find_available_simulator() {
    # Preferred simulators in order (newest first)
    local preferred=(
        "iPhone 17 Pro Max"
        "iPhone 17 Pro"
        "iPhone 17"
        "iPhone 16 Pro Max"
        "iPhone 16 Pro"
        "iPhone 16"
        "iPhone 15 Pro Max"
        "iPhone 15 Pro"
        "iPhone 15"
    )

    # Get list of available simulators
    local available
    available=$(xcrun simctl list devices available -j 2>/dev/null | grep -o '"name" : "[^"]*"' | sed 's/"name" : "//;s/"//')

    # Try preferred simulators first
    for sim in "${preferred[@]}"; do
        if echo "$available" | grep -qx "$sim"; then
            echo "$sim"
            return 0
        fi
    done

    # Fallback: find any iPhone simulator
    local fallback
    fallback=$(echo "$available" | grep -E "^iPhone" | head -1)
    if [ -n "$fallback" ]; then
        echo "$fallback"
        return 0
    fi

    return 1
}

get_base_simulator() {
    # If user specified a base simulator, use it
    if [ -n "$BASE_SIMULATOR" ]; then
        echo "$BASE_SIMULATOR"
        return 0
    fi

    # Otherwise, find an available one
    find_available_simulator
}

# Colors (only use if output is a terminal)
if [ -t 1 ]; then
    GREEN=$'\033[0;32m'
    BLUE=$'\033[0;34m'
    YELLOW=$'\033[1;33m'
    RED=$'\033[0;31m'
    NC=$'\033[0m'
else
    GREEN=''
    BLUE=''
    YELLOW=''
    RED=''
    NC=''
fi

get_simulator_name() {
    local task_name="$1"
    echo "convos-$task_name"
}

create_task_simulator() {
    local task_name="$1"
    local sim_name
    sim_name=$(get_simulator_name "$task_name")

    if xcrun simctl list devices | grep -q "$sim_name"; then
        echo -e "${YELLOW}Simulator '$sim_name' already exists${NC}"
        return 0
    fi

    local base_sim
    base_sim=$(get_base_simulator)

    if [ -z "$base_sim" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  No iPhone simulators found on this system${NC}"
        echo -e "${YELLOW}   Install Xcode simulators or set CONVOS_BASE_SIMULATOR${NC}"
        return 1
    fi

    echo -e "${BLUE}Creating simulator: $sim_name (cloning from $base_sim)${NC}"

    if ! xcrun simctl clone "$base_sim" "$sim_name" 2>/dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  Could not clone simulator '$base_sim'${NC}"
        echo -e "${YELLOW}   You can create one manually or set CONVOS_BASE_SIMULATOR${NC}"
        return 1
    fi

    echo -e "${GREEN}‚úÖ Created simulator: $sim_name${NC}"
    return 0
}

delete_task_simulator() {
    local task_name="$1"
    local sim_name
    sim_name=$(get_simulator_name "$task_name")

    if ! xcrun simctl list devices | grep -q "$sim_name"; then
        return 0
    fi

    echo -e "${BLUE}Deleting simulator: $sim_name${NC}"
    xcrun simctl delete "$sim_name" 2>/dev/null || true
    echo -e "${GREEN}‚úÖ Deleted simulator: $sim_name${NC}"
}

write_task_config() {
    local worktree_dir="$1"
    local task_name="$2"
    local sim_name
    sim_name=$(get_simulator_name "$task_name")

    cat > "$worktree_dir/.convos-task" << EOF
TASK_NAME=$task_name
SIMULATOR_NAME=$sim_name
EOF
}

launch_claude_in_terminal() {
    local dir="$1"
    local task_name="$2"
    local message=""

    if [ -n "$task_name" ]; then
        message="echo 'üöÄ Starting Claude Code for task: $task_name' && "
    fi

    # Check if iTerm is available (installed)
    if [ -d "/Applications/iTerm.app" ]; then
        # Check if iTerm is already running (process name is "iTerm", not "iTerm2")
        if osascript -e 'tell application "System Events" to (name of processes) contains "iTerm"' 2>/dev/null | grep -q "true"; then
            osascript <<EOF
tell application "iTerm"
    if (count of windows) > 0 then
        tell current window
            set newTab to (create tab with default profile)
            tell newTab
                tell current session
                    write text "cd '$dir' && ${message}claude"
                end tell
            end tell
        end tell
    else
        create window with default profile
        tell current window
            tell current session
                write text "cd '$dir' && ${message}claude"
            end tell
        end tell
    end if
    activate
end tell
EOF
        else
            # iTerm installed but not running - launch it
            osascript <<EOF
tell application "iTerm"
    activate
    delay 0.5
    tell current window
        tell current session
            write text "cd '$dir' && ${message}claude"
        end tell
    end tell
end tell
EOF
        fi
    else
        osascript <<EOF
tell application "Terminal"
    if (count of windows) > 0 then
        tell application "System Events" to keystroke "t" using command down
        delay 0.3
        do script "cd '$dir' && ${message}claude" in front window
    else
        do script "cd '$dir' && ${message}claude"
    end if
    activate
end tell
EOF
    fi
}

cmd_new() {
    local TASK_NAME="$1"
    local PARENT_BRANCH="$2"

    if [ -z "$TASK_NAME" ]; then
        echo -e "${RED}Usage: convos-task new <task-name> [parent-branch]${NC}"
        echo "Example: convos-task new push-notifications"
        echo "Example: convos-task new push-notifications main"
        exit 1
    fi

    # Validate task name format
    if [[ ! "$TASK_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        echo -e "${RED}Error: Task name must contain only letters, numbers, hyphens, and underscores${NC}"
        echo "Invalid: '$TASK_NAME'"
        exit 1
    fi

    WORKTREE_DIR="$BASE_DIR/$REPO_NAME-$TASK_NAME"

    # Check if worktree already exists
    if [ -d "$WORKTREE_DIR" ]; then
        echo -e "${RED}Error: Worktree already exists at $WORKTREE_DIR${NC}"
        exit 1
    fi

    cd "$MAIN_REPO"

    # Store original branch to return to it later
    ORIGINAL_BRANCH=$(git branch --show-current)

    # Sync with Graphite to get latest changes before creating new branch
    echo -e "${BLUE}Syncing with Graphite to get latest changes...${NC}"
    gt sync --no-interactive || {
        echo -e "${YELLOW}‚ö†Ô∏è  gt sync failed, continuing anyway${NC}"
    }

    # If parent branch specified, checkout first
    if [ -n "$PARENT_BRANCH" ]; then
        echo -e "${BLUE}Checking out parent branch: $PARENT_BRANCH${NC}"
        git checkout "$PARENT_BRANCH"
        ORIGINAL_BRANCH="$PARENT_BRANCH"
    fi

    echo -e "${BLUE}Creating Graphite branch: $TASK_NAME${NC}"

    # Create branch with Graphite (this stacks it on current branch)
    gt branch create "$TASK_NAME" --no-interactive || {
        echo -e "${RED}Failed to create Graphite branch${NC}"
        exit 1
    }

    # Get the current branch name (Graphite may have modified it)
    BRANCH_NAME=$(git branch --show-current)

    echo -e "${BLUE}Creating worktree at $WORKTREE_DIR${NC}"

    # Go back to original branch before creating worktree
    git checkout "$ORIGINAL_BRANCH"

    # Create worktree pointing to the new branch
    git worktree add "$WORKTREE_DIR" "$BRANCH_NAME"

    echo -e "${GREEN}‚úÖ Created worktree and Graphite branch${NC}"
    echo -e "${BLUE}üìÅ Location: $WORKTREE_DIR${NC}"
    echo -e "${BLUE}üåø Branch: $BRANCH_NAME${NC}"

    # Write task config file (includes simulator name for later use)
    write_task_config "$WORKTREE_DIR" "$TASK_NAME"

    SIM_NAME=$(get_simulator_name "$TASK_NAME")
    echo -e "${BLUE}üì± Simulator: $SIM_NAME (creating in background)${NC}"

    # Show stack info
    cd "$WORKTREE_DIR"
    echo -e "\n${BLUE}Graphite stack:${NC}"
    gt log short 2>/dev/null || gt stack 2>/dev/null || echo "Run 'gt stack' to see stack"

    # Create simulator in background (runs in current shell, doesn't block)
    local base_sim
    base_sim=$(get_base_simulator)
    if [ -n "$base_sim" ]; then
        (
            if ! xcrun simctl list devices | grep -q "$SIM_NAME"; then
                xcrun simctl clone "$base_sim" "$SIM_NAME" >/dev/null 2>&1
            fi
        ) &
    fi

    echo -e "\n${BLUE}Launching Claude Code...${NC}"
    launch_claude_in_terminal "$WORKTREE_DIR" "$TASK_NAME"
    echo -e "${GREEN}‚úÖ Claude Code launched${NC}"
}

cmd_list() {
    echo -e "${BLUE}Active worktrees:${NC}\n"

    cd "$MAIN_REPO"

    local WORKTREE_PATH=""
    local BRANCH=""

    git worktree list --porcelain | while IFS= read -r line; do
        case "$line" in
            worktree\ *)
                WORKTREE_PATH="${line#worktree }"
                ;;
            branch\ *)
                BRANCH="${line#branch refs/heads/}"
                ;;
            "")
                # Empty line indicates end of worktree entry
                if [ -n "$BRANCH" ]; then
                    echo -e "${GREEN}üìÅ $WORKTREE_PATH${NC}"
                    echo -e "   üåø Branch: $BRANCH"

                    # Try to get Graphite info and simulator info
                    if [ -d "$WORKTREE_PATH" ]; then
                        (cd "$WORKTREE_PATH" && {
                            PARENT=$(gt log short 2>/dev/null | grep "‚Üì" | head -1 | awk '{print $NF}' || echo "")
                            if [ -n "$PARENT" ]; then
                                echo -e "   üìö Parent: $PARENT"
                            fi
                        })
                        # Check for task config with simulator info
                        if [ -f "$WORKTREE_PATH/.convos-task" ]; then
                            SIM_NAME=$(grep "^SIMULATOR_NAME=" "$WORKTREE_PATH/.convos-task" | cut -d= -f2)
                            if [ -n "$SIM_NAME" ]; then
                                echo -e "   üì± Simulator: $SIM_NAME"
                            fi
                        fi
                    fi
                    echo ""
                fi
                # Reset for next entry
                WORKTREE_PATH=""
                BRANCH=""
                ;;
        esac
    done
}

cmd_switch() {
    local TASK_NAME="$1"

    if [ -z "$TASK_NAME" ]; then
        echo -e "${RED}Usage: convos-task switch <task-name>${NC}"
        echo "Tip: Run 'convos-task list' to see available tasks"
        exit 1
    fi

    WORKTREE_DIR="$BASE_DIR/$REPO_NAME-$TASK_NAME"

    if [ ! -d "$WORKTREE_DIR" ]; then
        echo -e "${RED}Error: Worktree not found at $WORKTREE_DIR${NC}"
        exit 1
    fi

    echo -e "${BLUE}Launching Claude Code for task: $TASK_NAME${NC}"
    launch_claude_in_terminal "$WORKTREE_DIR" "$TASK_NAME"
    echo -e "${GREEN}‚úÖ Claude Code launched${NC}"
}

cmd_submit() {
    local TASK_NAME="$1"

    if [ -z "$TASK_NAME" ]; then
        # If no task name, assume we're in a worktree
        if [[ "$(pwd)" == *"$REPO_NAME-"* ]]; then
            echo -e "${BLUE}Submitting current branch...${NC}"
            gt submit
        else
            echo -e "${RED}Usage: convos-task submit <task-name>${NC}"
            echo "Or run from within a worktree directory"
            exit 1
        fi
    else
        WORKTREE_DIR="$BASE_DIR/$REPO_NAME-$TASK_NAME"

        if [ ! -d "$WORKTREE_DIR" ]; then
            echo -e "${RED}Error: Worktree not found at $WORKTREE_DIR${NC}"
            exit 1
        fi

        cd "$WORKTREE_DIR"
        echo -e "${BLUE}Submitting task: $TASK_NAME${NC}"
        gt submit
    fi
}

cmd_sync() {
    local TASK_NAME="$1"

    if [ -z "$TASK_NAME" ]; then
        if [[ "$(pwd)" == *"$REPO_NAME-"* ]]; then
            echo -e "${BLUE}Syncing current worktree...${NC}"
            gt sync
        else
            echo -e "${RED}Usage: convos-task sync <task-name>${NC}"
            echo "Or run from within a worktree directory"
            exit 1
        fi
    else
        WORKTREE_DIR="$BASE_DIR/$REPO_NAME-$TASK_NAME"

        if [ ! -d "$WORKTREE_DIR" ]; then
            echo -e "${RED}Error: Worktree not found at $WORKTREE_DIR${NC}"
            exit 1
        fi

        cd "$WORKTREE_DIR"
        echo -e "${BLUE}Syncing task: $TASK_NAME${NC}"
        gt sync
    fi
}

cmd_cleanup() {
    local TASK_NAME="$1"

    if [ -z "$TASK_NAME" ]; then
        echo -e "${RED}Usage: convos-task cleanup <task-name>${NC}"
        exit 1
    fi

    WORKTREE_DIR="$BASE_DIR/$REPO_NAME-$TASK_NAME"

    if [ ! -d "$WORKTREE_DIR" ]; then
        echo -e "${RED}Error: Worktree not found at $WORKTREE_DIR${NC}"
        exit 1
    fi

    cd "$WORKTREE_DIR"
    BRANCH_NAME=$(git branch --show-current)

    SIM_NAME=$(get_simulator_name "$TASK_NAME")

    echo -e "${YELLOW}‚ö†Ô∏è  About to remove worktree, Graphite branch, and simulator:${NC}"
    echo -e "   üìÅ Worktree: $WORKTREE_DIR"
    echo -e "   üåø Branch: $BRANCH_NAME"
    echo -e "   üì± Simulator: $SIM_NAME"
    echo ""
    read -p "Are you sure? (y/N): " -n 1 -r
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        cd "$MAIN_REPO"

        # Remove worktree
        echo -e "${BLUE}Removing worktree...${NC}"
        git worktree remove "$WORKTREE_DIR" --force

        # Delete Graphite branch
        echo -e "${BLUE}Deleting Graphite branch...${NC}"
        if ! gt delete "$BRANCH_NAME" --force 2>&1; then
            echo -e "${YELLOW}‚ö†Ô∏è  Graphite delete failed, using git directly${NC}"
            git branch -D "$BRANCH_NAME"
        fi

        # Delete task simulator
        delete_task_simulator "$TASK_NAME"

        echo -e "${GREEN}‚úÖ Cleaned up task: $TASK_NAME${NC}"
    else
        echo -e "${BLUE}Cancelled.${NC}"
    fi
}

cmd_help() {
    cat << EOF
${BLUE}Convos iOS Task Management${NC}

Manage parallel tasks using git worktrees + Graphite

${GREEN}Commands:${NC}
  new <task-name> [parent]  Create new worktree and Graphite branch
  list                      List all active worktrees
  switch <task-name>        Open Claude Code in existing worktree
  submit [task-name]        Submit PR via Graphite (gt submit)
  sync [task-name]          Sync with Graphite stack (gt sync)
  cleanup <task-name>       Remove worktree and branch
  help                      Show this help

${GREEN}Examples:${NC}
  convos-task new push-notifications
  convos-task new bug-fix main
  convos-task list
  convos-task submit push-notifications
  convos-task cleanup push-notifications

${GREEN}Workflow:${NC}
  1. ${BLUE}convos-task new my-feature${NC}     # Creates worktree + launches Claude
  2. Work on feature in Claude Code...
  3. ${BLUE}convos-task submit my-feature${NC}   # Submit PR via Graphite
  4. ${BLUE}convos-task cleanup my-feature${NC}  # Remove when done

${YELLOW}Notes:${NC}
  - Each worktree is a separate Claude Code session
  - Graphite branches are automatically stacked
  - Each task gets a dedicated iOS simulator (convos-<task-name>)
  - Claude Code opens in iTerm 2 (preferred) or Terminal
  - Opens in new tab if window exists, new window otherwise
  - Base simulator is auto-detected (set CONVOS_BASE_SIMULATOR to override)
  - Use 'gt stack' in worktree to see stack structure
EOF
}

# Main command dispatcher
case "$1" in
    new)
        cmd_new "$2" "$3"
        ;;
    list|ls)
        cmd_list
        ;;
    switch|open)
        cmd_switch "$2"
        ;;
    submit|pr)
        cmd_submit "$2"
        ;;
    sync)
        cmd_sync "$2"
        ;;
    cleanup|done|rm)
        cmd_cleanup "$2"
        ;;
    help|--help|-h|"")
        cmd_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'convos-task help' for usage"
        exit 1
        ;;
esac
